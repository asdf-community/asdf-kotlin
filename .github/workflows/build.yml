name: Build

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  plugin_test:
    name: asdf plugin test
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: asdf_plugin_test
        uses: asdf-vm/actions/plugin-test@v1.1.0
        with:
          command: kotlin -help
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          path: kotlin
      - name: Move kotlin plugin to plugins dir
        run: |
          mkdir -p ${HOME}/.asdf/plugins/
          mv kotlin ${HOME}/.asdf/plugins/
      - name: Run kotlin specific tests
        run: |
          asdf plugin-add java
          echo "Will try to install java's openjdk-11.0.1"
          asdf install java openjdk-11.0.1
          echo "Trying to list all versions of kotlin"
          asdf list-all kotlin
          echo "Will add 'java openjdk-11.0.1' to ~/.tool-versions"
          echo "java openjdk-11.0.1" > ~/.tool-versions
          echo "Will try to install kotlin 1.0.3 (version without kotlin native)"
          asdf install kotlin 1.0.3
          echo "Will try to install kotlin 1.3.21 (version with kotlin native)"
          asdf install kotlin 1.3.21
          echo "Will try to install kotlin 1.4.30-RC (version with new kotlin native naming)"
          asdf install kotlin 1.4.30-RC
          echo "Will try to install kotlin 1.5.30-M1 (version with MacOS aarch64 kotlin native)"
          asdf install kotlin 1.5.30-M1
          echo "Setting kotlin 1.0.3 as the default value in ~/.tool-versions"
          echo 'kotlin 1.0.3' >> ~/.tool-versions
          echo "Confirming version 1.0.3"
          kotlin -version 2>&1 | grep '1.0.3'
          echo "Setting kotlin 1.3.21 as the default value in ~/.tool-versions"
          echo "java openjdk-11.0.1" > ~/.tool-versions
          echo 'kotlin 1.3.21' >> ~/.tool-versions
          echo "Confirming version 1.3.21"
          kotlin -version 2>&1 | grep '1.3.21'
          kotlinc-native -version 2>&1 | grep '1.3.21'
          echo "Setting kotlin 1.4.30-RC as the default value in ~/.tool-versions"
          echo "java openjdk-11.0.1" > ~/.tool-versions
          echo 'kotlin 1.4.30-RC' >> ~/.tool-versions
          echo "Confirming version 1.4.30-RC"
          kotlin -version 2>&1 | grep '1.4.30-RC'
          kotlinc-native -version 2>&1 | grep '1.4.30-RC'
          echo "Setting kotlin 1.5.30-M1 as the default value in ~/.tool-versions"
          echo "java openjdk-11.0.1" > ~/.tool-versions
          echo 'kotlin 1.5.30-M1' >> ~/.tool-versions
          echo "Confirming version 1.5.30-M1"
          kotlin -version 2>&1 | grep '1.5.30-M1'
          kotlinc-native -version 2>&1 | grep '1.5.30-M1'
